-- SET CURRENT SCHEMA = 'CWSRS1' ;

DROP VIEW VW_LST_REFERRAL_HIST;

CREATE VIEW VW_LST_REFERRAL_HIST (
  CLIENT_ID,
  CLIENT_SENSITIVITY_IND,
  REFERRAL_ID,
  START_DATE,
  END_DATE,
  REFERRAL_RESPONSE_TYPE,
  LIMITED_ACCESS_CODE,
  LIMITED_ACCESS_DATE,
  LIMITED_ACCESS_DESCRIPTION,
  LIMITED_ACCESS_GOVERNMENT_ENT,
  REFERRAL_LAST_UPDATED,
  REPORTER_ID,
  REPORTER_FIRST_NM,
  REPORTER_LAST_NM,
  REPORTER_LAST_UPDATED,
  WORKER_ID,
  WORKER_FIRST_NM,
  WORKER_LAST_NM,
  WORKER_LAST_UPDATED,
  PERPETRATOR_ID,
  PERPETRATOR_SENSITIVITY_IND,
  PERPETRATOR_FIRST_NM,
  PERPETRATOR_LAST_NM,
  PERPETRATOR_LAST_UPDATED,
  VICTIM_ID,
  VICTIM_SENSITIVITY_IND,
  VICTIM_FIRST_NM,
  VICTIM_LAST_NM,
  VICTIM_LAST_UPDATED,
  REFERRAL_COUNTY,
  ALLEGATION_ID,
  ALLEGATION_DISPOSITION,
  ALLEGATION_TYPE,
  ALLEGATION_LAST_UPDATED,
  RCT_IBMSNAP_LOGMARKER,
  RCT_IBMSNAP_OPERATION,
  RFL_IBMSNAP_LOGMARKER,
  RFL_IBMSNAP_OPERATION,
  STP_IBMSNAP_LOGMARKER,
  STP_IBMSNAP_OPERATION,
  RPT_IBMSNAP_LOGMARKER,
  RPT_IBMSNAP_OPERATION,
  ALG_IBMSNAP_LOGMARKER,
  ALG_IBMSNAP_OPERATION,
  CLP_IBMSNAP_LOGMARKER,
  CLP_IBMSNAP_OPERATION,
  CLV_IBMSNAP_LOGMARKER,
  CLV_IBMSNAP_OPERATION,
  LAST_CHG
) AS
SELECT
  CLT.IDENTIFIER AS CLIENT_ID,
  CLT.SENSTV_IND AS CLIENT_SENSITIVITY_IND,
  RFL.IDENTIFIER AS REFERRAL_ID,
  RFL.REF_RCV_DT AS START_DATE,
  RFL.REFCLSR_DT AS END_DATE,
  RFL.RFR_RSPC   AS REFERRAL_RESPONSE_TYPE,
  RFL.LMT_ACSSCD AS LIMITED_ACCESS_CODE,
  RFL.LMT_ACS_DT AS LIMITED_ACCESS_DATE,
  RFL.LMT_ACSDSC AS LIMITED_ACCESS_DESCRIPTION,
  RFL.L_GVR_ENTC AS LIMITED_ACCESS_GOVERNMENT_ENT,
  RFL.LST_UPD_TS AS REFERRAL_LAST_UPDATED,
  RPT.FKREFERL_T AS REPORTER_ID,
  RPT.RPTR_FSTNM AS REPORTER_FIRST_NM,
  RPT.RPTR_LSTNM AS REPORTER_LAST_NM,
  RPT.LST_UPD_TS AS REPORTER_LAST_UPDATED,
  STP.IDENTIFIER AS WORKER_ID,
  STP.FIRST_NM   AS WORKER_FIRST_NM,
  STP.LAST_NM    AS WORKER_LAST_NM,
  STP.LST_UPD_TS AS WORKER_LAST_UPDATED,
  CLP.IDENTIFIER AS PERPETRATOR_ID,
  CLP.SENSTV_IND AS PERPETRATOR_SENSITIVITY_IND,
  CLP.COM_FST_NM AS PERPETRATOR_FIRST_NM,
  CLP.COM_LST_NM AS PERPETRATOR_LAST_NM,
  CLP.LST_UPD_TS AS PERPETRATOR_LAST_UPDATED,
  CLV.IDENTIFIER AS VICTIM_ID,
  CLV.SENSTV_IND AS VICTIM_SENSITIVITY_IND,
  CLV.COM_FST_NM AS VICTIM_FIRST_NM,
  CLV.COM_LST_NM AS VICTIM_LAST_NM,
  CLV.LST_UPD_TS AS VICTIM_LAST_UPDATED,
  RFL.GVR_ENTC   AS REFERRAL_COUNTY,
  ALG.IDENTIFIER AS ALLEGATION_ID,
  ALG.ALG_DSPC   AS ALLEGATION_DISPOSITION,
  ALG.ALG_TPC    AS ALLEGATION_TYPE,
  ALG.LST_UPD_TS AS ALLEGATION_LAST_UPDATED,
  RCT.IBMSNAP_LOGMARKER AS RCT_IBMSNAP_LOGMARKER,
  RCT.IBMSNAP_OPERATION AS RCT_IBMSNAP_OPERATION,
  RFL.IBMSNAP_LOGMARKER AS RFL_IBMSNAP_LOGMARKER,
  RFL.IBMSNAP_OPERATION AS RFL_IBMSNAP_OPERATION,
  STP.IBMSNAP_LOGMARKER AS STP_IBMSNAP_LOGMARKER,
  STP.IBMSNAP_OPERATION AS STP_IBMSNAP_OPERATION,
  RPT.IBMSNAP_LOGMARKER AS RPT_IBMSNAP_LOGMARKER,
  RPT.IBMSNAP_OPERATION AS RPT_IBMSNAP_OPERATION,
  ALG.IBMSNAP_LOGMARKER AS ALG_IBMSNAP_LOGMARKER,
  ALG.IBMSNAP_OPERATION AS ALG_IBMSNAP_OPERATION,
  CLP.IBMSNAP_LOGMARKER AS CLP_IBMSNAP_LOGMARKER,
  CLP.IBMSNAP_OPERATION AS CLP_IBMSNAP_OPERATION,
  CLV.IBMSNAP_LOGMARKER AS CLV_IBMSNAP_LOGMARKER,
  CLV.IBMSNAP_OPERATION AS CLV_IBMSNAP_OPERATION,
  MAX ( CLT.IBMSNAP_LOGMARKER,
    NVL(RCT.IBMSNAP_LOGMARKER, TIMESTAMP('2008-09-30 11:54:40')),
    NVL(RFL.IBMSNAP_LOGMARKER, TIMESTAMP('2008-09-30 11:54:40')),
    NVL(STP.IBMSNAP_LOGMARKER, TIMESTAMP('2008-09-30 11:54:40')),
    NVL(RPT.IBMSNAP_LOGMARKER, TIMESTAMP('2008-09-30 11:54:40')),
    NVL(ALG.IBMSNAP_LOGMARKER, TIMESTAMP('2008-09-30 11:54:40')),
    NVL(CLP.IBMSNAP_LOGMARKER, TIMESTAMP('2008-09-30 11:54:40')),
    NVL(CLV.IBMSNAP_LOGMARKER, TIMESTAMP('2008-09-30 11:54:40'))
  ) AS LAST_CHG
FROM REFR_CLT      RCT
JOIN CLIENT_T      CLT ON CLT.IDENTIFIER  = RCT.FKCLIENT_T
LEFT JOIN REFERL_T RFL ON RCT.FKREFERL_T  = RFL.IDENTIFIER
LEFT JOIN STFPERST STP ON RFL.FKSTFPERST  = STP.IDENTIFIER
LEFT JOIN REPTR_T  RPT ON RPT.FKREFERL_T  = RFL.IDENTIFIER
LEFT JOIN ALLGTN_T ALG ON ALG.FKREFERL_T  = RFL.IDENTIFIER
LEFT JOIN CLIENT_T CLP ON CLP.IDENTIFIER  = ALG.FKCLIENT_0
LEFT JOIN CLIENT_T CLV ON CLV.IDENTIFIER  = ALG.FKCLIENT_T
WHERE RCT.FKREFERL_T IN (
	SELECT GT.IDENTIFIER FROM GT_ID GT
);

COMMIT;
